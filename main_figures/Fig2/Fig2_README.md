# Figure 2

This folder contains everything needed to reproduce the code-generated panels in **Figure 2**, including panel-specific data and (when needed) panel-specific external code.

---

## Contents

- `Fig2.py`  
  Entry script to reproduce Figure 2 (generates the figure and/or panel outputs).

- `Panel_D_data/`  
  Inputs and/or cached intermediates required for **Panel D**.

- `Panel_D_src/`
  External code for Panel D that requires a separate environment for **scCube**, **scMultiSim**, and **SRTsim**.  
---

## Environment

### Default (SimSpace)
Most of Figure 2 should run in the default environment:
```bash
# Run the line below if not creating the repro env before
# conda env create -f ../../environment.yml
conda activate simspace-repro
```

---

## Run Figure 2

From the repository root:
```bash
python main_figures/Fig2/Fig2.py
```

Or from this directory:
```bash
python Fig2.py
```

---

## Panel D data 

### MERFISH
External data downloaded from the study: Molecular, spatial, and functional single-cell profiling of the hypothalamic preoptic region [https://www.science.org/doi/10.1126/science.aau5324].

### sccube
Generated by the scCube script `Panel_D_src/sccube.ipynb`. Also the parameters, except the random seed, are the default settings in scCube's tutorials. 
- One key thing to know that, even the random seed is fixed, scCube will still have its outputs with randomness due to CPU/GPU choice or CUDA version. To best overcome this issue, we computed 9 replicates to avoid cherry-picking issue.

### scMultiSim
Generated by the scMultiSim script `Panel_D_src/scMultiSim.R`. Also the parameters, except the random seed, are the default settings in scMultiSim's tutorials. 

### SRTsim
Generated by the SRTsim script `Panel_D_src/SRTsim.R`. 
- SRTsimâ€™s reference-free workflow differs fundamentally from the others: rather than providing a programmatic procedure to generate diverse cell-type spatial patterns, it requires a human-in-the-loop drawing/interaction process to specify cell-type distributions. This makes it difficult to (i) generate patterns at scale in a standardized way, and (ii) reproduce results precisely across users. In our study, we made a best-effort attempt to manually define spatial distributions with as much detail as feasible, but the outcome necessarily depends on manual input and is therefore not directly comparable to fully algorithmic reference-free generators.
- Therefore, the script just provides the interface of SRTsim reference-free mode. To check our simulated SRTsim data, one can load them in SRTsim's interface as well.

### Xenium
External data downloaded from the study: High resolution mapping of the tumor microenvironment using integrated single-cell, spatial and in situ analysis [https://www.nature.com/articles/s41467-023-43458-x].


---

## Panel D src

### sccube.ipynb

To run the script, it is recommended to follow sccube's official installation guidance to create the corresponding conda env. For the reproducibility, we provided our scCube conda env files so that one can have the version controlled. To run the notbook:

```bash
# Run the line below if not creating the repro env before
# conda env create -f sccube_environment.yml
conda activate sccube
jupyter lab
```

### scMultiSim.R
Below is the session info:
```
R version 4.4.2 (2024-10-31)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.7.3

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/New_York
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] scMultiSim_1.2.0

loaded via a namespace (and not attached):
 [1] generics_0.1.4              SparseArray_1.6.2           lattice_0.22-7             
 [4] digest_0.6.37               magrittr_2.0.3              grid_4.4.2                 
 [7] RColorBrewer_1.1-3          iterators_1.0.14            foreach_1.5.2              
[10] jsonlite_2.0.0              Matrix_1.7-4                ape_5.8-1                  
[13] GenomeInfoDb_1.42.3         httr_1.4.7                  UCSC.utils_1.2.0           
[16] scales_1.4.0                codetools_0.2-20            abind_1.4-8                
[19] cli_3.6.5                   rlang_1.1.6                 crayon_1.5.3               
[22] XVector_0.46.0              Biobase_2.66.0              DelayedArray_0.32.0        
[25] Rtsne_0.17                  S4Arrays_1.6.0              tools_4.4.2                
[28] parallel_4.4.2              BiocParallel_1.40.2         dplyr_1.1.4                
[31] zeallot_0.2.0               ggplot2_4.0.1               GenomeInfoDbData_1.2.13    
[34] SummarizedExperiment_1.36.0 BiocGenerics_0.52.0         vctrs_0.6.5                
[37] R6_2.6.1                    matrixStats_1.5.0           stats4_4.4.2               
[40] lifecycle_1.0.4             zlibbioc_1.52.0             S4Vectors_0.44.0           
[43] IRanges_2.40.1              pkgconfig_2.0.3             pillar_1.10.2              
[46] gtable_0.3.6                glue_1.8.0                  Rcpp_1.0.14                
[49] tibble_3.3.0                GenomicRanges_1.58.0        tidyselect_1.2.1           
[52] rstudioapi_0.17.1           MatrixGenerics_1.18.1       dichromat_2.0-0.1          
[55] farver_2.1.2                nlme_3.1-168                compiler_4.4.2             
[58] S7_0.2.0                    markdown_2.0 
```

### SRTsim.R
Below is the session info:
```
R version 4.4.2 (2024-10-31)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.7.3

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/New_York
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] SRTsim_0.99.8

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1      viridisLite_0.4.2     concaveman_1.1.0      dplyr_1.1.4           farver_2.1.2         
 [6] viridis_0.6.5         S7_0.2.0              fastmap_1.2.0         lazyeval_0.2.2        spatstat.geom_3.4-1  
[11] promises_1.3.3        digest_0.6.37         mime_0.13             lifecycle_1.0.4       sf_1.0-21            
[16] spatstat.data_3.1-6   bezier_1.1.2          magrittr_2.0.3        compiler_4.4.2        rlang_1.1.6          
[21] tools_4.4.2           data.table_1.17.4     knitr_1.50            ggsignif_0.6.4        FNN_1.1.4.1          
[26] htmlwidgets_1.6.4     sp_2.2-0              classInt_0.4-11       RColorBrewer_1.1-3    abind_1.4-8          
[31] KernSmooth_2.23-26    purrr_1.0.4           BiocGenerics_0.52.0   polyclip_1.10-7       grid_4.4.2           
[36] rgl_1.3.18            stats4_4.4.2          ggpubr_0.6.0          colorspace_2.1-1      xtable_1.8-4         
[41] e1071_1.7-16          ggplot2_4.0.1         spatstat.utils_3.1-4  scales_1.4.0          iterators_1.0.14     
[46] MASS_7.3-65           dichromat_2.0-0.1     cli_3.6.5             generics_0.1.4        rstudioapi_0.17.1    
[51] httr_1.4.7            Rvcg_0.25             DBI_1.2.3             proxy_0.4-27          parallel_4.4.2       
[56] Morpho_2.12           matrixStats_1.5.0     base64enc_0.1-3       vctrs_0.6.5           pdist_1.2.1          
[61] Matrix_1.7-4          jsonlite_2.0.0        carData_3.0-5         car_3.1-3             S4Vectors_0.44.0     
[66] rstatix_0.7.2         Formula_1.2-5         magick_2.8.7          foreach_1.5.2         plotly_4.10.4        
[71] spatstat.univar_3.1-3 tidyr_1.3.1           colorRamps_2.3.4      units_0.8-7           shinyBS_0.61.1       
[76] spatstat.random_3.4-1 glue_1.8.0            codetools_0.2-20      DT_0.33               gtable_0.3.6         
[81] deldir_2.0-4          later_1.4.2           shinydashboard_0.7.3  tibble_3.3.0          pillar_1.10.2        
[86] htmltools_0.5.8.1     R6_2.6.1              doParallel_1.0.17     evaluate_1.0.3        shiny_1.10.0         
[91] lattice_0.22-7        backports_1.5.0       broom_1.0.8           httpuv_1.6.16         class_7.3-23         
[96] Rcpp_1.0.14           gridExtra_2.3         xfun_0.52             pkgconfig_2.0.3 
```

### Xenium_reference_count.csv & Xenium_reference_meta.csv

External data collected from High resolution mapping of the tumor microenvironment using integrated single-cell, spatial and in situ analysis [https://www.nature.com/articles/s41467-023-43458-x]. This tile will used as the reference for scCube as it requires a reference to generate the molecular data even for its refernece-free mode.